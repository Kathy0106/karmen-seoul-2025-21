<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦–çˆ¾è–èª•è‡ªç”±è¡Œ</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Zen Maru Gothic å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    <!-- è¼‰å…¥ Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* å®šç¾©ä¸»é¡Œé¡è‰²å’Œå­—é«” */
        :root {
            --color-fuji-blue: #92B7E5; /* å¯Œå£«è— */
            --color-snow-white: #FFFFFF;
            --color-warm-gray: #F5F7FA;
            --color-primary-accent: #FF7B8E; /* å¯æ„›ç²‰ç´…ä½œç‚ºé‡é»è‰² */
        }
        
        body {
            font-family: 'Zen Maru Gothic', 'Noto Sans TC', 'sans-serif';
            background-color: var(--color-warm-gray);
        }

        /* ç¢ºä¿å…§å®¹åœ¨åº•éƒ¨å°èˆªä¸Šæ–¹ */
        #app-content {
            padding-bottom: 72px; /* åº•éƒ¨å°èˆªæ¢é«˜åº¦ */
        }

        /* è‡ªå®šç¾©æ»¾å‹•æ¢ (å¯é¸ï¼Œæä¾›æ—¥å¼æŸ”å’Œæ„Ÿ) */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background-color: rgba(146, 183, 229, 0.5); /* å¯Œå£«è—åŠé€æ˜ */
            border-radius: 4px;
        }
        
        /* å¡ç‰‡ç·¨è¼¯æ¨¡å¼çš„è¼¸å…¥æ¡†æ¨£å¼ */
        .editable-input {
            width: 100%;
            padding: 4px 8px;
            margin-top: 4px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background-color: var(--color-snow-white);
            font-size: 0.9rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="app" class="max-w-md mx-auto shadow-2xl bg-white min-h-screen">
        <!-- App Content Area -->
        <div id="app-content">
            <!-- Header (å°‡ç”± JS æ¸²æŸ“) -->
            <header id="app-header" class="sticky top-0 z-10"></header>
            
            <!-- Daily Selector (å°‡ç”± JS æ¸²æŸ“) -->
            <div id="day-selector" class="sticky top-[100px] z-10 p-3 bg-white shadow-sm"></div>

            <!-- Content for selected tab and day -->
            <div id="main-content" class="p-4">
                <!-- Loading State -->
                <div id="loading-spinner" class="text-center p-8">
                    <i class="fas fa-spinner fa-spin fa-3x text-indigo-500"></i>
                    <p class="mt-4 text-gray-600">æ­£åœ¨è¼‰å…¥å¯æ„›çš„æ—…è¡Œè³‡æ–™...</p>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation Bar (å°‡ç”± JS æ¸²æŸ“) -->
        <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 max-w-md mx-auto z-20"></nav>

        <!-- Modals for Editing (Placeholder) -->
        <div id="modal-container"></div>
    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // setLogLevel('Debug'); // Open Firestore Debug Log
        
        // --- Globals & Initialization ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        
        let userId = null;
        let isAuthReady = false;
        
        // --- App State ---
        let state = {
            currentTab: 'Itinerary', // Itinerary | Guide | Weather | Expense
            currentDay: '12/25',
            itinerary: [],
            expense: [],
            budget: 500000, // Initial budget 500,000 KRW
            tripTitle: "é¦–çˆ¾è–èª•è‡ªç”±è¡Œ",
            tripDates: "2025/12/25 - 12/29",
            tabs: [
                { id: 'Itinerary', name: 'è¡Œç¨‹', icon: 'fas fa-calendar-alt' },
                { id: 'Guide', name: 'æŒ‡å—', icon: 'fas fa-map-marked-alt' },
                { id: 'Weather', name: 'å¤©æ°£', icon: 'fas fa-cloud-sun' },
                { id: 'Expense', name: 'æ¶ˆè²»', icon: 'fas fa-wallet' },
            ],
            flightInfo: [
                { type: 'Departure', flight: 'UO626', route: 'é¦™æ¸¯ (HKG) â†’ é¦–çˆ¾ (ICN)', time: '07:30 - 11:55', status: 'é è¨ˆæº–æ™‚' },
                { type: 'Return', flight: 'UO631', route: 'é¦–çˆ¾ (ICN) â†’ é¦™æ¸¯ (HKG)', time: '17:40 - 20:25', status: 'é è¨ˆæº–æ™‚' },
            ]
        };

        // --- Initial Data (Hardcoded Itinerary based on user prompt) ---
        const initialItineraryData = [
            { day: '12/25', date: '12/25', dayName: 'Day 1', area: 'å®‰åœ‹, å¼˜å¤§, æ˜æ´', items: [
                { category: 'æ—©é¤', name: 'Dotori Garden', koreanName: 'ë„í† ë¦¬ê°€ë“ ', address: 'ì„œìš¸ ì¢…ë¡œêµ¬ ë¶ì´Œë¡œ 4ê¸¸ 20', tags: ['å¿…æ‹'], description: 'å¯æ„›çš„æ¾é¼ ä¸»é¡Œå’–å•¡å»³ï¼Œå»ºè­°åœ¨æˆ¶å¤–åº­é™¢æ‹ç…§ï¼Œå…‰ç·šæœ€ä½³ã€‚', map: 'naver' },
                { category: 'è³¼ç‰©', name: 'å®‰åœ‹é€›è¡—é †è·¯', koreanName: 'ì œë¡œìŠ¤í˜ì´ìŠ¤, ì˜¤ë¸Œì íŠ¸, ì†Œì›”ë””íŒŒíŠ¸ë¨¼íŠ¸...', address: 'ë¶ì´Œë¡œ5ê°€ê¸¸ ä¸€å¸¶', tags: ['å¿…è²·'], description: 'ZERO SPACE, Object å®‰åœ‹, Sowol Department, INOUR MANSION, OINU, Tamburins å®‰åœ‹', map: 'naver' },
                { category: 'äº¤é€š', name: 'å®‰åœ‹ â†’ å¼˜å¤§', description: 'åœ°éµ18åˆ†é˜', map: '' },
                { category: 'åˆé¤', name: 'Gop Mapo çƒ¤è‚¥è…¸', koreanName: 'ê³±ë§ˆí¬', address: 'ì„œìš¸ ë§ˆí¬êµ¬ ë…ë§‰ë¡œ7ê¸¸ 51', tags: ['å¿…åƒ'], description: 'é¦¬æµ¦å€çš„ç‰¹è‰²çƒ¤è‚¥è…¸ï¼Œå£æ„Ÿé¦™è„†ï¼Œé©åˆå¤§å£åƒè‚‰ã€‚', map: 'naver' },
                { category: 'ä¸‹åˆèŒ¶', name: 'Artist Bakery å¼˜å¤§', koreanName: 'ì•„í‹°ìŠ¤íŠ¸ ë² ì´ì»¤ë¦¬', address: 'ì„œìš¸ ë§ˆí¬êµ¬ ë™êµë¡œ 251-3', tags: ['å¿…æ‹'], description: 'æ‹›ç‰Œé¹½éºµåŒ…å’Œæ­å¼éºµåŒ…ï¼Œæ˜¯å¼˜å¤§äººæ°£éºµåŒ…åº—ã€‚', map: 'naver' },
                { category: 'äº¤é€š', name: 'å¾’æ­¥ 12åˆ†é˜ â†’ å»¶å—æ´', description: 'äº«å—å»¶å—æ´çš„æ‚ é–’æ°›åœ', map: '' },
                { category: 'ç”œå“', name: 'å»¶å—æ´é£Ÿ & CafÃ©', koreanName: 'í›ˆí›ˆí˜¸ë–¡, íˆí¬ì»¤í”¼', address: 'ë™êµë¡œ30ê¸¸ 19 ä¸€å¸¶', tags: ['å¿…åƒ'], description: 'HUNHUN ç³–é¤…ï¼ˆç¶“å…¸éŸ“å¼ç”œé»ï¼‰åŠ HIPPO Coffeeï¼ˆç‰¹è‰²å’–å•¡ï¼‰ã€‚', map: 'naver' },
                { category: 'äº¤é€š', name: 'å»¶å—æ´ â†’ æ˜æ´', description: 'æ­ä¹˜åœ°éµ', map: '' },
                { category: 'æ™šé¤', name: 'ğŸ¦€çƒé”é‡Œå®¶ï¼ˆé†¬èŸ¹ï¼‰', koreanName: 'ì˜¤ë‹¤ë¦¬ì§‘ ê°„ì¥ê²Œì¥', address: 'ì„œìš¸ ì¤‘êµ¬ ëª…ë™8ë‚˜ê¸¸ 28 2â€“3ì¸µ', tags: ['å¿…åƒ', 'å¿…æ‹'], description: 'æ–°é®®ç”Ÿé†¬èŸ¹ï¼Œæ‹Œé£¯ä¸€æµã€‚', map: 'naver' },
                { category: 'æ™¯é»', name: 'æ˜æ´è–èª•ç‡ˆé£¾', koreanName: 'ëª…ë™ì„±ë‹¹', address: 'ì„œìš¸ ì¤‘êµ¬ ëª…ë™ê¸¸ 74', tags: ['å¿…æ‹'], description: 'æ¬£è³æ˜æ´è–å ‚çš„è–èª•ç‡ˆé£¾ï¼Œå……æ»¿ç¯€æ—¥æ°£æ°›ã€‚', map: 'naver' },
            ]},
            { day: '12/26', date: '12/26', dayName: 'Day 2', area: 'æ˜æ´, å—å¤§é–€, æ±å¤§é–€, æ–°å ‚', items: [
                { category: 'æ—©é¤', name: 'å®‹å®¶é£¯æ²ï¼ˆæ˜æ´ï¼‰', koreanName: 'ì†¡ê°€ê¹€ë°¥', address: 'ì„œìš¸ ì¤‘êµ¬ í‡´ê³„ë¡œ 120', tags: ['å¿…åƒ'], description: 'ç°¡å–®ç¾å‘³çš„éŸ“å¼é£¯æ²ï¼Œä½œç‚ºæ—©é¤å¿«é€Ÿåˆæ–¹ä¾¿ã€‚', map: 'naver' },
                { category: 'è³¼ç‰©', name: 'æ˜æ´è³¼ç‰©å€', koreanName: 'ëª…ë™ê±°ë¦¬', address: 'ì„œìš¸ ì¤‘êµ¬ ëª…ë™ê¸¸ ä¸€å¸¶', tags: ['å¿…è²·'], description: 'è—¥å¦ã€æœé£¾ã€è¡—é ­å°åƒæ‡‰æœ‰ç›¡æœ‰ã€‚', map: 'naver' },
                { category: 'åˆé¤', name: 'éŸ“ç‰›ä¸€æ¢è¡—ï¼ˆé€€æºªè·¯ï¼‰', koreanName: 'í‡´ê³„ë¡œ í•œìš°ê³¨ëª©', address: 'ì„œìš¸ ì¤‘êµ¬ í‡´ê³„ë¡œ 180ê¸¸ ä¸€å¸¶', tags: ['å¿…åƒ'], description: 'å“åšéŸ“åœ‹é ‚ç´šéŸ“ç‰›çš„èšé›†åœ°ã€‚', map: 'naver' },
                { category: 'è³¼ç‰©', name: 'å—å¤§é–€å¸‚å ´', koreanName: 'ë‚¨ëŒ€ë¬¸ì‹œì¥', address: 'ì„œìš¸ ì¤‘êµ¬ ë‚¨ëŒ€ë¬¸ì‹œì¥4ê¸¸ 21', tags: ['å¿…è²·'], description: 'éŸ“åœ‹æœ€å¤§çš„å‚³çµ±å¸‚å ´ï¼Œé©åˆè²·æ‰‹ä¿¡ã€‚', map: 'naver' },
                { category: 'è³¼ç‰©', name: 'Doota Mall + No Brand æƒè²¨', koreanName: 'ë‘íƒ€ëª°', address: 'ì„œìš¸ ì¤‘êµ¬ ì¥ì¶©ë‹¨ë¡œ 275', tags: ['å¿…è²·'], description: 'Dootaæ™‚å°šè³¼ç‰©å•†å ´ï¼Œåˆ¥å¿˜äº†åˆ° No Brand è³¼è²·é›¶é£Ÿæ—¥ç”¨å“ã€‚', map: 'naver' },
                { category: 'ç”œå“', name: 'Scooper Gelato', koreanName: 'ìŠ¤ì¿ í¼ ì ¤ë¼í† ', address: 'ë‘íƒ€ëª° åœ°ä¸‹å±¤', tags: ['å¿…åƒ'], description: 'é–‹å¿ƒæœ Affogato å¿…è©¦ã€‚', map: 'naver' },
                { category: 'æ™šé¤', name: 'å‹èª¼è¾£é›çˆªï¼ˆæ–°å ‚ï¼‰ğŸ”¥', koreanName: 'ìš°ì •ë‹­ë°œ', address: 'ì„œìš¸ ì¤‘êµ¬ í‡´ê³„ë¡œ 421 (æ–°å ‚ ë‹­ë°œ ê³¨ëª©)', tags: ['å¿…åƒ'], description: 'æ–°å ‚è¾£é›çˆªä¸€æ¢è¡—çš„ä»£è¡¨ï¼ŒæŒ‘æˆ°éŸ“åœ‹çš„è¾£å‘³ã€‚', map: 'naver' },
            ]},
            { day: '12/27', date: '12/27', dayName: 'Day 3', area: 'å®‰åœ‹, ç›Šå–„æ´, ä¹™æ”¯è·¯', items: [
                { category: 'æ—©é¤', name: 'Cafe Layeredï¼ˆå®‰åœ‹ï¼‰', koreanName: 'ì¹´í˜ ë ˆì´ì–´ë“œ', address: 'ì„œìš¸ ì¢…ë¡œêµ¬ ë¶ì´Œë¡œ 6', tags: ['å¿…åƒ', 'å¿…æ‹'], description: 'è‘—åçš„è‹±å¼å¸åº·åº—ï¼Œå¾©å¤æ°›åœé©åˆæ‰“å¡ã€‚', map: 'naver' },
                { category: 'åˆé¤', name: 'Nakwonjangï¼ˆç›Šå–„æ´ï¼‰', koreanName: 'ë‚™ì›ì¥', address: 'ì„œìš¸ ì¢…ë¡œêµ¬ ìˆ˜í‘œë¡œ28ê¸¸ 33', tags: ['å¿…åƒ'], description: 'ç›Šå–„æ´çš„ç†±é–€éŸ“å±‹é¤å»³ï¼Œæä¾›æ–°å¼éŸ“é£Ÿã€‚', map: 'naver' },
                { category: 'è³¼ç‰©', name: 'ç›Šå–„æ´è¡Œå°åº—ï¼æ‰“å¡', koreanName: 'ìµì„ ë™ í•œì˜¥ê±°ë¦¬', address: 'ì„œìš¸ ì¢…ë¡œêµ¬ ìˆ˜í‘œë¡œ28ê¸¸ ä¸€å¸¶', tags: ['å¿…æ‹'], description: 'åœ¨å……æ»¿æ‡·èˆŠæ°£æ°›çš„éŸ“å±‹è¡—é“ä¸Šé–’é€›å°åº—ã€æ‹ç¾ç…§ã€‚', map: 'naver' },
                { category: 'æ™šé¤', name: 'æ°´èŠ¹èœçƒ¤è±¬è‚‰ï¼ˆä¹™æ”¯è·¯ï¼‰', koreanName: 'ëŒíŒ ìˆ˜ë¯¸ë‚˜ë¬¼ ì‚¼ê²¹ì‚´', address: 'ì„œìš¸ ì¤‘êµ¬ ìˆ˜í‘œë¡œ 48-1', tags: ['å¿…åƒ'], description: 'ç‰¹è‰²çš„çŸ³æ¿çƒ¤ä¸‰å±¤è‚‰ï¼Œæ­é…æ–°é®®æ°´èŠ¹èœã€‚', map: 'naver' },
                { category: 'æ´»å‹•', name: 'ğŸŒ™ é£¯å¾Œè‡ªç”±æ´»å‹•', description: 'å›é…’åº— / ä¾¿åˆ©åº— / æ˜æ´æ•£æ­¥ çš†å¯', map: '' },
            ]},
            { day: '12/28', date: '12/28', dayName: 'Day 4', area: 'è–æ°´ ALL DAY, æ˜æ´', items: [
                { category: 'æ—©é¤', name: 'Onion è–æ°´', koreanName: 'ì–´ë‹ˆì–¸ ì„±ìˆ˜', address: 'ì„œìš¸ ì„±ë™êµ¬ ì•„ì°¨ì‚°ë¡œ17ê¸¸ 33', tags: ['å¿…åƒ', 'å¿…æ‹'], description: 'ç”±å»¢æ£„å·¥å» æ”¹å»ºçš„è¶…äººæ°£å’–å•¡å»³ï¼Œå¿…è©¦æ‹›ç‰ŒéºµåŒ…ã€‚', map: 'naver' },
                { category: 'è³¼ç‰©', name: 'è–æ°´æ½®æµæ•£æ­¥', koreanName: 'ë¬´ì‹ ì‚¬, ì•„ë”ì—ëŸ¬, íƒ¬ë²„ë¦°ì¦ˆ', address: 'ì—°ë¬´ì¥ê¸¸ ä¸€å¸¶', tags: ['å¿…è²·'], description: 'é€› Musinsa Standardã€ADER ERROR æ——è‰¦åº—å’Œ Tamburins è–æ°´åº—ï¼Œæ„Ÿå—æ½®æµæ°£æ¯ã€‚', map: 'naver' },
                { category: 'åˆé¤', name: 'ç„¡å¢å±‹', koreanName: 'ë¬´ì¿ ìš°ë™', address: 'ì„œìš¸ ì„±ë™êµ¬ ì„œìš¸ìˆ²2ê¸¸ 28-13', tags: ['å¿…åƒ'], description: 'ä»¥æ¸…æ·¡æ¹¯é ­èåçš„çƒå†¬åº—ï¼Œç°¡ç´„æ—¥å¼é¢¨æ ¼ã€‚', map: 'naver' },
                { category: 'ç”œå“', name: 'Milky Shop', koreanName: 'ë°€í‚¤ìƒµ', address: 'ì„œìš¸ ì„±ë™êµ¬ ì„œìš¸ìˆ²2ê¸¸ 19-13', tags: ['å¿…åƒ'], description: 'è–æ°´æ´äººæ°£é›ªç³•åº—ï¼Œé©åˆé£¯å¾Œä¾†é»ç”œé»ã€‚', map: 'naver' },
                { category: 'äº¤é€š', name: 'è–æ°´ â†’ æ˜æ´', description: 'åœ°éµ 20â€“25åˆ†é˜', map: '' },
                { category: 'æ™šé¤', name: 'æ™šé¤äºŒé¸ä¸€', description: 'â‘  IDAEJO æ’éª¨æ¹¯ / â‘¡ æ˜æ´ç‚¸é› (æ©‹æ‘/bb.q/NENE)', map: '' },
                { category: 'æ™šé¤', name: 'IDAEJO æ’éª¨æ¹¯', koreanName: 'ì´ëŒ€ì¡° ê°ìíƒ•', address: 'ì„œìš¸ ì„œëŒ€ë¬¸êµ¬ ì´í™”ì—¬ëŒ€3ê¸¸ 22', tags: ['é¸æ“‡'], description: 'ç¶“å…¸éŸ“å¼é¦¬éˆ´è–¯æ’éª¨æ¹¯ã€‚', map: 'naver' },
                { category: 'æ™šé¤', name: 'æ˜æ´ç‚¸é›', koreanName: 'êµì´Œì¹˜í‚¨, ë¹„ë¹„í, ë„¤ë„¤ì¹˜í‚¨', address: 'æ˜æ´8ê°€ê¸¸ ä¸€å¸¶', tags: ['é¸æ“‡'], description: 'åœ¨æ˜æ´é¸æ“‡ä¸€å®¶ä½ æœ€å–œæ­¡çš„ç‚¸é›åº—ï¼Œå¦‚æ©‹æ‘ã€bb.q æˆ– NENEã€‚', map: 'naver' },
            ]},
            { day: '12/29', date: '12/29', dayName: 'Day 5', area: 'æ˜æ´ â†’ æ©Ÿå ´', items: [
                { category: 'æ—©é¤', name: 'Egg Dropï¼ˆæ˜æ´ï¼‰', koreanName: 'ì—ê·¸ë“œë', address: 'ì„œìš¸ ì¤‘êµ¬ ëª…ë™ê¸¸ 24', tags: ['å¿…åƒ'], description: 'è‘—åçš„éŸ“å¼åå¸é€£é–åº—ï¼Œä½œç‚ºå›ç¨‹å‰çš„æ—©é¤ã€‚', map: 'naver' },
                { category: 'è³¼ç‰©', name: 'æ˜æ´æœ€å¾Œæƒè²¨', koreanName: 'ëª…ë™ê±°ë¦¬', address: 'ì„œìš¸ ì¤‘êµ¬ ëª…ë™ê¸¸ ä¸€å¸¶', tags: ['å¿…è²·'], description: 'åœ¨å›ç¨‹å‰é€²è¡Œæœ€å¾Œçš„è—¥å¦æˆ–é›¶é£Ÿè£œçµ¦ã€‚', map: 'naver' },
                { category: 'åˆé¤', name: 'è±å·é°»é­š', koreanName: 'í’ì²œì¥ì–´', address: 'ì„œìš¸ ì¤‘êµ¬ ëª…ë™4ê¸¸ 10', tags: ['å¿…åƒ'], description: 'åœ¨åˆé¤æ™‚æ®µäº«ç”¨é«˜ç´šçš„çƒ¤é°»é­šï¼Œç‚ºæ—…ç¨‹ç•«ä¸Šå¥è™Ÿã€‚', map: 'naver' },
                { category: 'äº¤é€š', name: 'âœˆï¸ é£¯å¾Œ â†’ æ©Ÿå ´', description: 'å›é…’åº—é ˜å–è¡Œæï¼Œå‰å¾€ä»å·/é‡‘æµ¦æ©Ÿå ´ã€‚', map: '' },
            ]},
        ];

        // --- Helper Functions ---
        const mapUrl = (address, type = 'google') => {
            if (type === 'naver') {
                return `https://map.naver.com/p/search/${encodeURIComponent(address)}?c=15.00,0,0,0,zh-Hant`;
            }
            return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
        };
        
        const formatCurrency = (amount, currency = 'KRW') => {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: currency, minimumFractionDigits: 0 }).format(amount);
        };

        const getTagClasses = (tag) => {
            switch (tag) {
                case 'å¿…åƒ': return 'bg-red-400/80 text-white';
                case 'å¿…è²·': return 'bg-yellow-400/80 text-gray-800';
                case 'å¿…æ‹': return 'bg-indigo-400/80 text-white';
                case 'é¸æ“‡': return 'bg-green-400/80 text-white';
                default: return 'bg-gray-400/80 text-white';
            }
        };

        const getCategoryIcon = (category) => {
            switch (category) {
                case 'æ—©é¤':
                case 'åˆé¤':
                case 'æ™šé¤':
                case 'ç”œå“':
                case 'ä¸‹åˆèŒ¶':
                    return 'fas fa-utensils text-green-500';
                case 'è³¼ç‰©': return 'fas fa-shopping-bag text-pink-500';
                case 'æ™¯é»': return 'fas fa-camera-retro text-yellow-500';
                case 'æ´»å‹•':
                case 'æ´»å‹•': return 'fas fa-hiking text-purple-500';
                case 'é…’åº—': return 'fas fa-bed text-blue-500';
                case 'äº¤é€š': return 'fas fa-bus-alt text-gray-500';
                default: return 'fas fa-info-circle text-indigo-500';
            }
        };

        // --- Firebase Interaction ---
        // Ensure db is initialized before calling this
        const getItineraryRef = () => doc(db, "artifacts", appId, "users", userId, "SeoulTripPlanner", "itinerary");
        const getExpensesRef = () => doc(db, "artifacts", appId, "users", userId, "SeoulTripPlanner", "expenses");
        
        const saveItineraryToFirestore = async (data) => {
            if (!userId) { /* console.error("User not authenticated, cannot save itinerary."); */ return; }
            try {
                const docRef = getItineraryRef();
                await setDoc(docRef, { data: data, lastUpdated: new Date() }, { merge: true });
                // console.log("Itinerary saved to Firestore.");
            } catch (e) {
                // console.error("Error saving itinerary: ", e);
            }
        };

        const saveExpensesToFirestore = async (data, budget) => {
            if (!userId) { /* console.error("User not authenticated, cannot save expenses."); */ return; }
            try {
                const docRef = getExpensesRef();
                await setDoc(docRef, { expenses: data, budget: budget, lastUpdated: new Date() }, { merge: true });
                // console.log("Expenses saved to Firestore.");
            } catch (e) {
                // console.error("Error saving expenses: ", e);
            }
        };

        // --- Event Handlers (Bound via onclick) ---
        
        // These are defined outside the module scope to be callable from inline HTML onclick attributes
        window.switchTab = (tabId) => {
            if (state.currentTab === tabId) return;
            state.currentTab = tabId;
            // When switching tabs, if we are going to itinerary, make sure day selector is visible
            if (tabId === 'Itinerary') {
                document.getElementById('day-selector').style.display = 'block';
            } else {
                document.getElementById('day-selector').style.display = 'none';
            }
            renderApp();
        };

        window.switchDay = (date) => {
            if (state.currentDay === date) return;
            state.currentDay = date;
            renderApp();
        };

        // Header Edit Handlers
        window.handleTitleEdit = (newTitle) => {
            state.tripTitle = newTitle;
            renderHeader(); 
        };
        
        window.handleDatesEdit = (newDates) => {
            state.tripDates = newDates;
            renderHeader(); 
        };
        
        // Itinerary Edit Handlers
        window.toggleEditItineraryItem = (day, index) => {
            const dayData = state.itinerary.find(d => d.date === day);
            if (!dayData) return;

            const item = dayData.items[index];
            
            if (item.isEditing) {
                // Save changes
                const cardEl = document.getElementById(`item-${day}-${index}`);
                // Use querySelector within the specific item card
                const inputName = cardEl.querySelector('[data-field="name"]').value;
                const inputKoreanName = cardEl.querySelector('[data-field="koreanName"]').value;
                const inputAddress = cardEl.querySelector('[data-field="address"]').value;
                const inputDescription = cardEl.querySelector('[data-field="description"]').value;
                
                // Update state
                item.name = inputName;
                item.koreanName = inputKoreanName;
                item.address = inputAddress;
                item.description = inputDescription;
                
                item.isEditing = false;
                saveItineraryToFirestore(state.itinerary);
            } else {
                // Start editing
                item.isEditing = true;
            }
            renderItineraryTab();
        };

        window.deleteItineraryItem = (day, index) => {
            if (!confirm("ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹é …ç›®ï¼Ÿ")) return;
            const dayData = state.itinerary.find(d => d.date === day);
            if (!dayData) return;
            
            dayData.items.splice(index, 1);
            saveItineraryToFirestore(state.itinerary);
            renderItineraryTab();
        };

        window.addItemToDay = () => {
            const dayData = state.itinerary.find(d => d.date === state.currentDay);
            if (!dayData) { return; }
            
            const newItem = {
                category: 'æ´»å‹•', 
                name: 'æ–°å¢æ´»å‹•åç¨±', 
                koreanName: '', 
                address: '', 
                tags: ['å¿…æ‹'], 
                description: 'é»æ“Šå„²å­˜æŒ‰éˆ•é–‹å§‹å¡«å¯«å…§å®¹ï¼', 
                map: 'naver',
                isEditing: true
            };
            
            dayData.items.push(newItem);
            renderItineraryTab();
        };

        window.addNewDay = () => {
            const newDate = prompt("è«‹è¼¸å…¥æ–°å¢ä¸€å¤©çš„æ—¥æœŸ (ä¾‹å¦‚: 12/30)");
            if (!newDate) return;

            if (state.itinerary.some(d => d.date === newDate)) {
                alert("è©²æ—¥æœŸå·²å­˜åœ¨ã€‚");
                return;
            }

            const newDay = {
                day: newDate, 
                date: newDate, 
                dayName: 'æ–°å¢ Day', 
                area: 'æœªå®š', 
                items: [{ category: 'æ´»å‹•', name: 'å…¨æ—¥è‡ªç”±æ´»å‹•', description: 'æ–°çš„ä¸€å¤©ï¼' }]
            };
            
            state.itinerary.push(newDay);
            state.itinerary.sort((a, b) => new Date(a.date) - new Date(b.date)); // Sort by date
            saveItineraryToFirestore(state.itinerary);
            state.currentDay = newDate;
            renderApp();
        };
        
        // Expense Edit Handlers
        window.editBudget = () => {
            const newBudget = prompt("è«‹è¼¸å…¥æ–°çš„ç¸½é ç®— (éŸ“å…ƒ KRW):", state.budget);
            if (newBudget !== null && !isNaN(parseInt(newBudget))) {
                state.budget = parseInt(newBudget);
                saveExpensesToFirestore(state.expense, state.budget);
                renderExpenseTab();
            }
        };

        window.editExpenseName = (index) => {
            const item = state.expense[index];
            const newName = prompt("ç·¨è¼¯æ¶ˆè²»åç¨±:", item.name);
            if (newName !== null && newName.trim() !== '') {
                item.name = newName.trim();
                saveExpensesToFirestore(state.expense, state.budget);
                renderExpenseTab();
            }
        };

        window.editExpenseAmount = (index) => {
            const item = state.expense[index];
            const newAmount = prompt("ç·¨è¼¯èŠ±è²»é‡‘é¡ (KRW):", item.amount);
            if (newAmount !== null && !isNaN(parseInt(newAmount))) {
                item.amount = parseInt(newAmount);
                saveExpensesToFirestore(state.expense, state.budget);
                renderExpenseTab();
            }
        };

        window.deleteExpense = (index) => {
            if (!confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†æ¶ˆè²»ç´€éŒ„ï¼Ÿ")) return;
            state.expense.splice(index, 1);
            saveExpensesToFirestore(state.expense, state.budget);
            renderExpenseTab();
        };

        window.addExpense = () => {
            const name = prompt("æ¶ˆè²»åç¨±:");
            if (!name) return;
            const amount = prompt("èŠ±è²»é‡‘é¡ (KRW):");
            if (!amount || isNaN(parseInt(amount))) { return; }
            const category = prompt("æ¶ˆè²»é¡åˆ¥ (ä¾‹: é£Ÿç‰©, äº¤é€š, è³¼ç‰©):", "è³¼ç‰©");
            
            const newExpense = {
                name: name.trim(),
                amount: parseInt(amount),
                category: category || 'å…¶ä»–',
                date: new Date().toLocaleDateString('zh-Hant', { month: '2-digit', day: '2-digit' }),
            };
            
            state.expense.push(newExpense);
            saveExpensesToFirestore(state.expense, state.budget);
            renderExpenseTab();
        };
        
        // --- Rendering Functions ---

        const renderHeader = () => {
            const headerEl = document.getElementById('app-header');
            headerEl.innerHTML = `
                <div class="h-[160px] relative bg-[var(--color-fuji-blue)] overflow-hidden rounded-b-3xl shadow-xl">
                    <!-- Cute background (Mock with SVG/CSS for single file) -->
                    <div class="absolute inset-0 opacity-80" style="background: linear-gradient(135deg, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 100%);"></div>
                    
                    <!-- Main Content -->
                    <div class="absolute inset-0 flex flex-col justify-end p-6">
                        <div class="text-3xl font-bold text-white mb-1" contenteditable="true" onblur="window.handleTitleEdit(this.innerText)">${state.tripTitle}</div>
                        <div class="text-lg text-white/90" contenteditable="true" onblur="window.handleDatesEdit(this.innerText)">${state.tripDates}</div>
                    </div>

                    <!-- Cute Cartoon Banner (Placeholder/CSS Art) -->
                    <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mt-16 -mr-8"></div>
                    <div class="absolute top-4 right-4 text-white/90">
                        <i class="fas fa-plane text-2xl"></i>
                    </div>
                </div>
            `;
        };

        const renderBottomNav = () => {
            const navEl = document.getElementById('bottom-nav');
            // åº•éƒ¨å°èˆªå¯¦è‰²ï¼ˆå·²æ”¹ç‚ºå¯Œå£«è—ï¼‰
            navEl.innerHTML = `
                <div class="flex justify-around h-16 shadow-2xl rounded-t-2xl border-t border-gray-100 p-2" style="background-color: var(--color-fuji-blue);">
                    ${state.tabs.map(tab => `
                        <button onclick="window.switchTab('${tab.id}')" 
                                class="flex flex-col items-center justify-center p-1 rounded-xl transition-all duration-200 
                                ${state.currentTab === tab.id 
                                    ? 'bg-white text-indigo-700 shadow-md transform scale-105' 
                                    : 'text-white/80 hover:text-white'}"
                                style="width: 24%; max-width: 80px;">
                            <i class="${tab.icon} text-lg mb-1"></i>
                            <span class="text-xs font-semibold">${tab.name}</span>
                        </button>
                    `).join('')}
                </div>
            `;
        };

        const renderDaySelector = () => {
            const selectorEl = document.getElementById('day-selector');
            // Only render if we have itinerary data
            if (state.itinerary.length === 0) {
                selectorEl.innerHTML = '';
                return;
            }

            const days = state.itinerary.map(item => item.date);
            
            selectorEl.innerHTML = `
                <div class="flex overflow-x-auto space-x-2 pb-2">
                    ${days.map(date => `
                        <button onclick="window.switchDay('${date}')"
                                class="flex-shrink-0 px-4 py-2 text-sm font-semibold rounded-full transition-colors duration-200 shadow-md
                                ${state.currentDay === date 
                                    ? 'bg-red-400 text-white shadow-red-300/50' 
                                    : 'bg-white text-gray-700 hover:bg-gray-100'}">
                            ${date.substring(0, 5)}
                        </button>
                    `).join('')}
                    <!-- Add Day Button -->
                    <button onclick="window.addNewDay()" 
                            class="flex-shrink-0 w-10 h-10 bg-indigo-500 text-white rounded-full shadow-lg hover:bg-indigo-600 transition-transform transform hover:scale-105">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            `;
        };

        const renderItineraryTab = () => {
            const contentEl = document.getElementById('main-content');
            const currentDayData = state.itinerary.find(d => d.date === state.currentDay);

            if (!currentDayData) {
                contentEl.innerHTML = `<div class="p-8 text-center text-gray-500">æ­¤æ—¥ç„¡è¡Œç¨‹ã€‚è«‹åœ¨ä¸Šæ–¹é¸æ“‡å…¶ä»–æ—¥æœŸæˆ–æ–°å¢è¡Œç¨‹ã€‚</div>`;
                return;
            }

            // Mock Weather & Attire Info
            // Could add an API call here for real weather
            const mockWeather = { temp: '-2Â°C / 5Â°C', condition: 'æ™´æœ—/å¾®é›ª', attire: 'åšç¾½çµ¨å¤–å¥—ã€æ¯›å¸½ã€ä¿æš–é´', snow: 'è·¯é¢å¯èƒ½çµå†°' };

            let html = `
                <div class="space-y-6">
                    <!-- Daily Weather Card -->
                    ${renderDailyWeatherCard(mockWeather)}

                    <!-- Itinerary Items -->
                    ${currentDayData.items.map((item, index) => renderItineraryItemCard(item, index)).join('')}
                    
                    <!-- Add Item Button -->
                    <div class="text-center py-4">
                        <button onclick="window.addItemToDay()" class="px-6 py-3 bg-red-400 text-white font-bold rounded-full shadow-xl hover:bg-red-500 transition-transform transform hover:scale-105">
                            <i class="fas fa-plus mr-2"></i> æ–°å¢è¡Œç¨‹
                        </button>
                    </div>
                </div>
            `;
            contentEl.innerHTML = html;
        };

        const renderDailyWeatherCard = (weather) => {
            return `
                <div class="p-4 bg-white rounded-2xl shadow-lg border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-sun text-yellow-500 mr-2"></i> ${state.currentDay} å³æ™‚å¤©æ°£
                    </h3>
                    <div class="flex justify-between items-center text-gray-600 mb-3">
                        <span class="text-4xl font-extrabold text-indigo-600">${weather.temp.split('/')[0]}</span>
                        <span class="text-base">${weather.condition}</span>
                    </div>
                    
                    <div class="border-t pt-3 space-y-2 text-sm text-gray-600">
                        <p class="flex items-center"><i class="fas fa-tshirt mr-2 text-red-400"></i> **å»ºè­°ç©¿è‘—:** ${weather.attire}</p>
                        <p class="flex items-center"><i class="fas fa-snowflake mr-2 text-blue-400"></i> **é›ªæ³æç¤º:** ${weather.snow}</p>
                    </div>
                </div>
            `;
        };

        const renderItineraryItemCard = (item, index) => {
            const isEditing = item.isEditing || false;
            const day = state.currentDay;
            
            // Photo Tip Mock
            const photoTip = item.koreanName && item.koreanName.includes('ì„±ìˆ˜') ? 'å°è²¼å£«ï¼šè–æ°´å€å·¥å» æ„Ÿå¤–ç‰†é©åˆæ‹å·¥æ¥­é¢¨ç…§ç‰‡ã€‚' : 'å°è²¼å£«ï¼šå»ºè­°åœ¨æˆ¶å¤–åº­é™¢æ‹ç…§ï¼Œå…‰ç·šæœ€ä½³ã€‚';

            return `
                <div id="item-${day}-${index}" class="bg-white p-4 rounded-2xl shadow-xl border-l-4 border-red-400/80 transition-all duration-300">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center w-full pr-12">
                            <i class="${getCategoryIcon(item.category)} text-xl mr-3"></i>
                            ${isEditing ? `
                                <input type="text" value="${item.name}" placeholder="è¡Œç¨‹åç¨±" class="editable-input text-lg font-bold" data-field="name">
                            ` : `
                                <h4 class="text-lg font-bold text-gray-800">${item.name}</h4>
                            `}
                        </div>
                        <div class="absolute top-4 right-4 flex space-x-2">
                            <button onclick="window.toggleEditItineraryItem('${day}', ${index})" 
                                    class="w-8 h-8 rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200">
                                <i class="${isEditing ? 'fas fa-save' : 'fas fa-edit'} text-sm"></i>
                            </button>
                            <button onclick="window.deleteItineraryItem('${day}', ${index})" 
                                    class="w-8 h-8 rounded-full bg-red-100 text-red-500 hover:bg-red-200">
                                <i class="fas fa-trash-alt text-sm"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap gap-2 mb-3">
                        <!-- Category/Tags display (Simplified category input for edit) -->
                        <span class="px-2 py-0.5 text-xs font-medium rounded-full ${getTagClasses(item.category)}">${item.category}</span>
                        ${item.tags.map(tag => `<span class="px-2 py-0.5 text-xs font-medium rounded-full ${getTagClasses(tag)}">${tag}</span>`).join('')}
                    </div>

                    ${isEditing ? `
                        <input type="text" value="${item.koreanName || ''}" placeholder="éŸ“æ–‡åç¨±" class="editable-input" data-field="koreanName">
                        <input type="text" value="${item.address || ''}" placeholder="åœ°å€" class="editable-input" data-field="address">
                        <textarea placeholder="æè¿°" class="editable-input h-16" data-field="description">${item.description || ''}</textarea>
                    ` : `
                        <p class="text-sm text-gray-600 mb-2">${item.description || item.koreanName}</p>
                        ${item.address ? `<p class="text-xs text-gray-500 mb-3 flex items-center"><i class="fas fa-map-marker-alt mr-1 text-red-400"></i> ${item.address}</p>` : ''}
                    `}

                    <div class="flex justify-between items-center pt-3 border-t border-dashed border-gray-200">
                        <!-- Navigation -->
                        ${item.address ? `
                            <a href="${mapUrl(item.address, item.map || 'naver')}" target="_blank" class="text-xs text-indigo-600 font-semibold hover:text-indigo-800 transition-colors">
                                <i class="fas fa-map-pin mr-1"></i> ${item.map === 'naver' ? 'Naver åœ°åœ–å°èˆª' : 'Google åœ°åœ–å°èˆª'}
                            </a>
                        ` : '<span class="text-xs text-gray-400">ç„¡å°èˆªè³‡è¨Š</span>'}

                        <!-- Interactive Buttons -->
                        <div class="flex space-x-3 text-sm">
                            <button class="text-gray-500 hover:text-indigo-500"><i class="fas fa-upload mr-1"></i> æ—…è¨˜ä¸Šå‚³</button>
                            <button title="${photoTip}" class="text-gray-500 hover:text-indigo-500"><i class="fas fa-lightbulb mr-1"></i> æ‹ç…§æŠ€å·§</button>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderGuideTab = () => {
            const contentEl = document.getElementById('main-content');
            
            // Mock Exchange Rate
            // Real exchange rate needs external API
            const mockRate = { 
                KRW_HKD: 0.0058, // Mock rate: 1 KRW = 0.0058 HKD
                lastUpdated: new Date().toLocaleTimeString('zh-Hant', {hour: '2-digit', minute:'2-digit'})
            };

            const flightHtml = state.flightInfo.map(f => `
                <div class="flex justify-between items-center p-4 bg-white rounded-xl shadow-md border-l-4 ${f.type === 'Departure' ? 'border-indigo-400' : 'border-red-400'}">
                    <div>
                        <p class="font-bold text-gray-800">${f.type === 'Departure' ? 'å»ç¨‹' : 'å›ç¨‹'} ${f.flight}</p>
                        <p class="text-sm text-gray-600">${f.route}</p>
                        <p class="text-xs text-gray-500">${f.time}</p>
                    </div>
                    <span class="px-3 py-1 text-sm font-semibold rounded-full ${f.status === 'é è¨ˆæº–æ™‚' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                        ${f.status}
                    </span>
                </div>
            `).join('');

            contentEl.innerHTML = `
                <div class="space-y-6">
                    <!-- Exchange Rate Card -->
                    <div class="p-4 bg-white rounded-2xl shadow-lg border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-700 mb-3 flex items-center">
                            <i class="fas fa-exchange-alt text-blue-500 mr-2"></i> å³æ™‚å°æ›ç‡ (KRW/HKD)
                        </h3>
                        <div class="text-center">
                            <p class="text-5xl font-extrabold text-red-400">1 KRW</p>
                            <p class="text-3xl font-semibold text-gray-800 mt-2">â‰ˆ ${mockRate.KRW_HKD.toFixed(4)} HKD</p>
                            <p class="text-xs text-gray-500 mt-2">åŒ¯ç‡æ›´æ–°æ™‚é–“ï¼š${mockRate.lastUpdated} (Mock Data)</p>
                            <button class="mt-3 text-sm text-indigo-600 font-medium hover:underline">
                                <i class="fas fa-sync-alt mr-1"></i> åˆ·æ–°åŒ¯ç‡ (æ¨¡æ“¬)
                            </button>
                        </div>
                    </div>

                    <!-- Flight Status Card -->
                    <div class="p-4 bg-white rounded-2xl shadow-lg border border-gray-100 space-y-3">
                        <h3 class="text-lg font-bold text-gray-700 flex items-center mb-3">
                            <i class="fas fa-plane-departure text-indigo-500 mr-2"></i> èˆªç­ç‹€æ³
                        </h3>
                        ${flightHtml}
                    </div>

                    <!-- Map Integration Placeholder -->
                    <div class="p-4 bg-white rounded-2xl shadow-lg border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-700 flex items-center mb-3">
                            <i class="fas fa-map text-green-500 mr-2"></i> éŸ“åœ‹åœ°åœ– (Naver å„ªå…ˆ)
                        </h3>
                        <div class="h-40 bg-gray-100 rounded-lg flex items-center justify-center text-sm text-gray-500">
                            **Naver åœ°åœ–é€£çµå·²åµŒå…¥è¡Œç¨‹å¡ç‰‡ä¸­**
                            <br>
                            é»æ“Šè¡Œç¨‹ä¸­çš„å°èˆªæŒ‰éˆ•å¯é–‹å•Ÿ Naver åœ°åœ–ã€‚
                        </div>
                    </div>
                </div>
            `;
        };
        
        const renderWeatherTab = () => {
            const contentEl = document.getElementById('main-content');
            contentEl.innerHTML = `<div class="p-8 text-center text-gray-500">
                <i class="fas fa-cloud-sun-rain fa-3x mb-4 text-indigo-400"></i>
                <h3 class="text-xl font-bold mb-2">å¤©æ°£é å ±</h3>
                <p>é€™è£¡å°‡é¡¯ç¤ºé¦–çˆ¾äº”æ—¥å¤©æ°£é å ±ã€‚</p>
                <p class="text-sm mt-2">ï¼ˆå³æ™‚å¤©æ°£æ•¸æ“šéœ€è¦ API æ”¯æ´ï¼‰</p>
            </div>`;
        };

        const renderExpenseTab = () => {
            const contentEl = document.getElementById('main-content');
            
            const totalSpentKRW = state.expense.reduce((sum, item) => sum + item.amount, 0);
            const remainingBudget = state.budget - totalSpentKRW;
            const remainingBudgetHKD = remainingBudget * 0.0058; // Using mock rate

            let expenseListHtml = state.expense.map((item, index) => `
                <div class="flex justify-between items-center p-3 bg-white rounded-xl shadow-md border-l-4 border-yellow-400/80">
                    <div class="flex-1 min-w-0">
                        <!-- Double click to edit name -->
                        <p class="font-bold text-gray-800 truncate" ondblclick="window.editExpenseName(${index})" id="expense-name-${index}">${item.name}</p>
                        <p class="text-xs text-gray-500">${item.date} | ${item.category}</p>
                    </div>
                    <div class="flex items-center space-x-3 ml-3">
                        <!-- Double click to edit amount -->
                        <p class="font-bold text-red-500 min-w-[100px] text-right" ondblclick="window.editExpenseAmount(${index})" id="expense-amount-display-${index}">${formatCurrency(item.amount)}</p>
                        <button onclick="window.deleteExpense(${index})" class="text-gray-400 hover:text-red-500 w-6 h-6"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
            `).join('');

            contentEl.innerHTML = `
                <div class="space-y-6">
                    <!-- Budget Overview Card -->
                    <div class="p-4 bg-red-50 rounded-2xl shadow-lg border border-red-200">
                        <h3 class="text-lg font-bold text-red-700 mb-2 flex items-center">
                            <i class="fas fa-chart-pie mr-2"></i> é ç®—æ¦‚è¦½
                        </h3>
                        <div class="grid grid-cols-2 gap-2 text-sm font-semibold">
                            <p class="text-gray-600">ç¸½é ç®— (KRW)</p>
                            <!-- Double click to edit budget -->
                            <p class="text-right text-indigo-600" ondblclick="window.editBudget()">${formatCurrency(state.budget)}</p>
                            <p class="text-gray-600">å·²èŠ±è²» (KRW)</p>
                            <p class="text-right text-red-500">${formatCurrency(totalSpentKRW)}</p>
                            <p class="text-gray-600 border-t pt-2">å‰©é¤˜é ç®— (KRW)</p>
                            <p class="text-right border-t pt-2 ${remainingBudget < 0 ? 'text-red-600' : 'text-green-600'}">${formatCurrency(remainingBudget)}</p>
                            <p class="text-gray-600">ç´„å‰©é¤˜ (HKD)</p>
                            <p class="text-right ${remainingBudget < 0 ? 'text-red-600' : 'text-green-600'}">${formatCurrency(remainingBudgetHKD, 'HKD')}</p>
                        </div>
                    </div>

                    <!-- Expense List -->
                    <h3 class="text-lg font-bold text-gray-700 flex items-center">
                        <i class="fas fa-receipt mr-2 text-yellow-500"></i> æ¶ˆè²»ç´€éŒ„
                    </h3>
                    <div class="space-y-3">
                        ${expenseListHtml || '<div class="p-4 text-center text-gray-500 bg-white rounded-xl shadow-md">æš«ç„¡æ¶ˆè²»ç´€éŒ„</div>'}
                    </div>

                    <!-- Add Expense Button -->
                    <div class="text-center py-4">
                        <button onclick="window.addExpense()" class="px-6 py-3 bg-yellow-400 text-white font-bold rounded-full shadow-xl hover:bg-yellow-500 transition-transform transform hover:scale-105">
                            <i class="fas fa-plus mr-2"></i> æ–°å¢é–‹æ”¯
                        </button>
                    </div>
                </div>
            `;
        };


        // --- Main Render Function ---
        const renderApp = () => {
            renderHeader();
            renderBottomNav();
            
            // Render specific tab content
            document.getElementById('loading-spinner').classList.add('hidden');
            switch (state.currentTab) {
                case 'Itinerary':
                    // Make sure day selector is displayed for Itinerary tab
                    document.getElementById('day-selector').style.display = 'block';
                    renderDaySelector();
                    renderItineraryTab();
                    break;
                case 'Guide':
                    document.getElementById('day-selector').style.display = 'none';
                    renderGuideTab();
                    break;
                case 'Weather':
                    document.getElementById('day-selector').style.display = 'none';
                    renderWeatherTab();
                    break;
                case 'Expense':
                    document.getElementById('day-selector').style.display = 'none';
                    renderExpenseTab();
                    break;
            }
        };

        // --- App Start Up ---
        const startApp = async (uid) => {
            userId = uid;
            isAuthReady = true;
            
            // 1. Setup Itinerary Listener (initial load & real-time updates)
            onSnapshot(getItineraryRef(), (doc) => {
                if (doc.exists()) {
                    state.itinerary = doc.data().data || initialItineraryData;
                    // Reset current day if it was deleted
                    if (!state.itinerary.some(d => d.date === state.currentDay) && state.itinerary.length > 0) {
                        state.currentDay = state.itinerary[0].date;
                    } else if (state.itinerary.length > 0 && !state.currentDay) {
                        state.currentDay = state.itinerary[0].date;
                    }
                } else {
                    state.itinerary = initialItineraryData;
                    saveItineraryToFirestore(initialItineraryData);
                }
                renderApp();
            }, (error) => {
                // Fallback: use hardcoded data if Firestore fails to load
                state.itinerary = initialItineraryData;
                renderApp();
            });

            // 2. Setup Expenses Listener
            onSnapshot(getExpensesRef(), (doc) => {
                if (doc.exists()) {
                    state.expense = doc.data().expenses || [];
                    state.budget = doc.data().budget || 500000;
                } else {
                    state.expense = [];
                    state.budget = 500000;
                    saveExpensesToFirestore(state.expense, state.budget);
                }
                // Only re-render if we are on the expense tab
                if (state.currentTab === 'Expense') {
                    renderApp();
                }
            }, (error) => {
                // console.error("Error listening to expense changes:", error);
            });
        };

        // --- Authentication Check and Firebase Initialization ---
        // Initialize Firebase services outside of the listener's scope
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            // console.error("Firebase initialization failed:", e);
            // Will fallback to anonymous mode if auth fails later
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                await startApp(user.uid);
            } else {
                // No user is signed in, sign in with custom token or anonymously
                try {
                    if (initialAuthToken) {
                        const credential = await signInWithCustomToken(auth, initialAuthToken);
                        await startApp(credential.user.uid);
                    } else {
                        const credential = await signInAnonymously(auth);
                        await startApp(credential.user.uid);
                    }
                } catch (error) {
                    // Fallback in case of auth failure (app won't save/load data)
                    await startApp('anonymous-failed');
                }
            }
        });
        
        // Initial render for loading state
        renderHeader(); 
        
    </script>
</body>
</html>
