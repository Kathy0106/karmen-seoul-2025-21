import React, { useState, useEffect, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, collection, onSnapshot, setDoc, deleteDoc, query, orderBy, serverTimestamp, setLogLevel } from 'firebase/firestore';
import { LucideLogOut, LucideUserPlus, LucideLogIn, LucideSend, LucideTrash2, LucideCalendar } from 'lucide-react';

// ----------------------------------------------------------------------
// ⚠️ 你的 Firebase 配置資訊 (已根據你提供的資料填寫) 
// ----------------------------------------------------------------------
const firebaseConfig = {
  apiKey: "AIzaSyCUXPfj2Jhb5XYo9WXoAOEBvoiSqsJevaM",
  authDomain: "seoul-trip-fba4f.firebaseapp.com",
  projectId: "seoul-trip-fba4f",
  storageBucket: "seoul-trip-fba4f.firebasestorage.app",
  messagingSenderId: "653263885176",
  appId: "1:653263885176:web:43c5d546e6ac826261ee8d",
  measurementId: "G-XXTWKBSC7J"
};

// 由於 Canvas 環境會提供，但在本地運行時可能沒有，我們設定預設值
const __app_id = 'seoul-xmas-trip-v2';
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const initialAuthToken = null; // 暫時不需要使用 custom token

// ----------------------------------------------------------------------
// Firestore 路徑定義 (使用私有資料路徑)
// ----------------------------------------------------------------------

/**
 * 構建 Firestore 中用戶私人行程文件的路徑。
 * 格式: /artifacts/{appId}/users/{userId}/trip_plans/{docId}
 * 這裡我們使用一個固定的 document ID: 'my_seoul_trip'
 */
const TRIP_DOC_PATH = (userId) => ({
    collectionPath: `artifacts/${appId}/users/${userId}/trip_data`,
    docId: 'my_seoul_trip'
});

// ----------------------------------------------------------------------
// 主應用程式組件
// ----------------------------------------------------------------------

const App = () => {
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    
    // 認證狀態
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [authMode, setAuthMode] = useState('login'); // 'login' or 'register'
    const [authError, setAuthError] = useState('');

    // 行程資料狀態
    const [plan, setPlan] = useState(null); // 整個旅行計畫文件
    const [newItemText, setNewItemText] = useState('');
    const [loading, setLoading] = useState(true);
    const [dataError, setDataError] = useState('');


    // 1. 初始化 Firebase 和認證
    useEffect(() => {
        try {
            // 啟用 Firebase 日誌以幫助除錯
            setLogLevel('debug');
            
            const app = initializeApp(firebaseConfig);
            const firebaseAuth = getAuth(app);
            const firestoreDb = getFirestore(app);

            setAuth(firebaseAuth);
            setDb(firestoreDb);

            // 設置認證狀態監聽器
            const unsubscribe = onAuthStateChanged(firebaseAuth, (user) => {
                if (user) {
                    setUserId(user.uid);
                    // 為了多用戶識別，顯示完整的 UID
                    console.log('User signed in:', user.uid); 
                } else {
                    setUserId(null);
                    setPlan(null);
                    console.log('User signed out.');
                }
                setIsAuthReady(true);
            });

            // 處理 Canvas 初始化 Token（如果有的話，但我們這裡手動登入）
            if (initialAuthToken && firebaseAuth) {
                // 如果有 token 則嘗試用 token 登入
                // 這裡我們主要使用 Email/Password，所以省略 token 登入邏輯
            }


            return () => unsubscribe();
        } catch (e) {
            console.error("Firebase Initialization Error:", e);
            setDataError('Firebase 初始化失敗，請檢查配置。');
        }
    }, []);

    // 2. 認證操作 (登入/註冊/登出)
    const handleAuth = async () => {
        setAuthError('');
        if (!auth || !email || !password) {
            setAuthError('請輸入電子郵件和密碼。');
            return;
        }

        try {
            if (authMode === 'register') {
                await createUserWithEmailAndPassword(auth, email, password);
                alertMessage('註冊成功！您已自動登入。', 'success');
            } else {
                await signInWithEmailAndPassword(auth, email, password);
                alertMessage('登入成功！', 'success');
            }
        } catch (error) {
            console.error("Auth Error:", error);
            const friendlyMessage = error.message.includes('email-already-in-use') ? '此電子郵件已被註冊。' :
                                    error.message.includes('wrong-password') || error.message.includes('user-not-found') ? '電子郵件或密碼錯誤。' :
                                    '認證失敗: ' + error.message;
            setAuthError(friendlyMessage);
        }
    };

    const handleSignOut = async () => {
        if (auth) {
            await signOut(auth);
            setAuthError('');
            setEmail('');
            setPassword('');
            setAuthMode('login');
            alertMessage('您已登出。', 'info');
        }
    };

    // 3. Firestore 資料監聽
    useEffect(() => {
        if (!isAuthReady || !db || !userId) {
            setPlan(null);
            setLoading(false);
            return;
        }

        setDataError('');
        setLoading(true);

        const { collectionPath, docId } = TRIP_DOC_PATH(userId);
        const docRef = doc(db, collectionPath, docId);

        console.log('Attaching Firestore listener to:', collectionPath, docId);

        const unsubscribe = onSnapshot(docRef, 
            (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    setPlan(data);
                    console.log("Current data:", data);
                } else {
                    // 如果文件不存在，設置一個空基礎結構
                    setPlan({ days: [] });
                    console.log("No such document! Initializing empty plan.");
                }
                setLoading(false);
            }, 
            (error) => {
                console.error("Firestore Snapshot Error:", error);
                setDataError('無法載入行程數據。請檢查網路連線或權限。');
                setLoading(false);
            }
        );

        return () => unsubscribe();
    }, [isAuthReady, db, userId]);

    // 4. 資料操作邏輯
    
    // 儲存整個文件 (用於初始化或重大更新)
    const savePlan = useCallback(async (newPlan) => {
        if (!db || !userId) return;
        setDataError('');
        try {
            const { collectionPath, docId } = TRIP_DOC_PATH(userId);
            const docRef = doc(db, collectionPath, docId);
            await setDoc(docRef, newPlan, { merge: true });
            console.log("Plan updated successfully.");
        } catch (error) {
            console.error("Error saving plan:", error);
            setDataError('儲存行程失敗。');
        }
    }, [db, userId]);

    // 添加新的行程項目
    const handleAddItem = async (dayIndex) => {
        if (!plan || !db || !userId || !newItemText.trim()) return;

        const updatedPlan = { ...plan };
        
        // 確保 days 陣列存在
        if (!updatedPlan.days || updatedPlan.days.length <= dayIndex) {
            // 如果 days 陣列不存在或長度不足，先初始化它。
            // 這裡我們假設只有一天，如果需要多天，需要更複雜的 UI 邏輯。
            updatedPlan.days = [{ id: 1, date: '12月24日', activities: [] }];
            dayIndex = 0;
        }

        const newActivity = {
            id: Date.now(), // 簡單的唯一 ID
            text: newItemText.trim(),
            timestamp: serverTimestamp() // 使用 Firebase 時間戳記
        };

        updatedPlan.days[dayIndex].activities = [
            ...(updatedPlan.days[dayIndex].activities || []), 
            newActivity
        ];

        setNewItemText('');
        await savePlan(updatedPlan);
    };

    // 刪除行程項目
    const handleDeleteItem = async (dayIndex, activityId) => {
        if (!plan || !db || !userId) return;

        const updatedPlan = { ...plan };
        
        // 過濾掉要刪除的活動
        updatedPlan.days[dayIndex].activities = updatedPlan.days[dayIndex].activities
            .filter(activity => activity.id !== activityId);
        
        await savePlan(updatedPlan);
    };

    // 5. UI 組件/渲染邏輯
    
    // 警告/訊息顯示 (取代 alert)
    const alertMessage = (message, type = 'error') => {
        // 這裡使用一個簡單的狀態變數來顯示訊息，但為了 React 單一檔案限制，我們直接使用 setAuthError
        setAuthError(message);
        setTimeout(() => setAuthError(''), 5000); // 5秒後清除
    };

    const LoadingSpinner = () => (
        <div className="flex justify-center items-center p-4">
            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"></div>
            <span className="ml-3 text-indigo-600">載入中...</span>
        </div>
    );
    
    const AuthForm = () => (
        <div className="w-full max-w-md mx-auto p-6 bg-white rounded-xl shadow-2xl space-y-4">
            <h2 className="text-3xl font-bold text-center text-indigo-700">
                {authMode === 'login' ? '會員登入' : '註冊帳號'}
            </h2>
            {authError && (
                <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-3 rounded-md text-sm">
                    {authError}
                </div>
            )}
            <input
                type="email"
                placeholder="電子郵件 (e.g., user@example.com)"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
            />
            <input
                type="password"
                placeholder="密碼"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
            />
            <button
                onClick={handleAuth}
                className="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-300 transform hover:scale-[1.01]"
            >
                {authMode === 'login' ? <><LucideLogIn className="w-5 h-5 mr-2" /> 登入</> : <><LucideUserPlus className="w-5 h-5 mr-2" /> 註冊</>}
            </button>
            
            <button
                onClick={() => setAuthMode(authMode === 'login' ? 'register' : 'login')}
                className="w-full text-center text-indigo-500 hover:text-indigo-700 text-sm py-2 transition duration-150"
            >
                {authMode === 'login' ? '還沒有帳號？點此註冊' : '已經有帳號？點此登入'}
            </button>
        </div>
    );

    const PlannerView = () => {
        // 假設只有一天的行程 (為了簡化 UI)
        const dayPlan = plan?.days?.[0] || { date: '12月24日', activities: [] };

        return (
            <div className="w-full max-w-4xl mx-auto p-6 bg-white rounded-xl shadow-2xl space-y-8">
                {/* 頂部用戶資訊與登出 */}
                <div className="flex justify-between items-center pb-4 border-b border-indigo-100">
                    <div className="flex flex-col">
                        <h1 className="text-3xl font-extrabold text-gray-800 flex items-center">
                            <LucideCalendar className="w-8 h-8 text-indigo-500 mr-2" />
                            首爾聖誕旅行計畫
                        </h1>
                        <p className="text-sm text-gray-500 mt-1">
                            用戶 ID: <span className="font-mono text-xs bg-indigo-50 text-indigo-800 p-1 rounded-md">{userId}</span>
                        </p>
                    </div>
                    <button
                        onClick={handleSignOut}
                        className="flex items-center px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-150 shadow-md transform hover:scale-[1.05]"
                    >
                        <LucideLogOut className="w-5 h-5 mr-2" />
                        登出
                    </button>
                </div>

                {/* 添加行程項目 */}
                <div className="space-y-4">
                    <h2 className="text-xl font-bold text-gray-700">新增 {dayPlan.date} 的行程：</h2>
                    <div className="flex space-x-3">
                        <input
                            type="text"
                            placeholder="輸入活動內容 (例如: 明洞購物, 晚餐烤肉)"
                            value={newItemText}
                            onChange={(e) => setNewItemText(e.target.value)}
                            onKeyDown={(e) => e.key === 'Enter' && handleAddItem(0)}
                            className="flex-grow px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                        />
                        <button
                            onClick={() => handleAddItem(0)}
                            disabled={!newItemText.trim()}
                            className="flex items-center px-6 py-3 bg-indigo-600 text-white rounded-lg shadow-lg hover:bg-indigo-700 disabled:bg-indigo-300 transition duration-300 transform hover:scale-105"
                        >
                            <LucideSend className="w-5 h-5 mr-2" />
                            添加
                        </button>
                    </div>
                </div>

                {/* 行程列表 */}
                <div className="space-y-4">
                    <h2 className="text-2xl font-bold text-indigo-600 border-b-2 border-indigo-200 pb-2">{dayPlan.date} 行程清單</h2>
                    
                    {dayPlan.activities.length === 0 ? (
                        <p className="text-gray-500 italic p-4 bg-indigo-50 rounded-lg border border-indigo-100">
                            目前沒有任何行程，快來新增吧！
                        </p>
                    ) : (
                        <ul className="space-y-3">
                            {dayPlan.activities
                                .sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0)) // 根據時間戳記排序
                                .map((activity, index) => (
                                    <li key={activity.id} className="flex items-center justify-between p-4 bg-gray-50 rounded-xl shadow-md hover:shadow-lg transition duration-200">
                                        <div className="flex items-start flex-1">
                                            <span className="font-semibold text-lg text-indigo-600 mr-3 w-8 text-center flex-shrink-0">
                                                {index + 1}.
                                            </span>
                                            <p className="text-gray-800 text-lg break-words flex-1">
                                                {activity.text}
                                            </p>
                                        </div>
                                        <button
                                            onClick={() => handleDeleteItem(0, activity.id)}
                                            className="ml-4 p-2 text-red-500 hover:text-red-700 bg-red-100 rounded-full transition duration-150 hover:bg-red-200"
                                            aria-label="Delete item"
                                        >
                                            <LucideTrash2 className="w-5 h-5" />
                                        </button>
                                    </li>
                                ))
                            }
                        </ul>
                    )}
                </div>
            </div>
        );
    };


    if (!isAuthReady) {
        return <div className="min-h-screen flex items-center justify-center bg-gray-100"><LoadingSpinner /></div>;
    }

    return (
        <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
            {userId ? (
                // 已登入用戶顯示規劃器
                loading ? <LoadingSpinner /> : <PlannerView />
            ) : (
                // 未登入用戶顯示認證表單
                <AuthForm />
            )}
            {dataError && (
                 <div className="fixed bottom-4 right-4 bg-red-600 text-white p-4 rounded-lg shadow-xl max-w-sm z-50">
                    <p className="font-bold">數據錯誤</p>
                    <p className="text-sm">{dataError}</p>
                 </div>
            )}
        </div>
    );
};

export default App;

